function mainLoop(){scene.draw(),requestAnimFrame(mainLoop)}function clone(a){function b(){}return b.prototype=a,new b}function forEachIn(a,b){for(var c in a)a.hasOwnProperty(c)&&b(c,a[c])}function findAngle(a,b,c,d){return b==d?a>c?Math.PI:0:a==c?b>d?Math.PI/2:3*Math.PI/2:(angle=-Math.atan((d-b)/(c-a)),c<a?angle+=Math.PI:d>b&&(angle+=2*Math.PI),angle)}var canvas,context,ipad,canvasWidth,canvasHeight,scene;$(document).ready(function(){scene=Scene.create(),ipad=window.navigator.userAgent.match("iPad")?!0:!1,canvas=$("#animation_canvas").get(0),context=canvas.getContext("2d"),canvasWidth=canvas.width,canvasHeight=canvas.height,window.devicePixelRatio==2&&(canvas.setAttribute("width",canvasWidth*2),canvas.setAttribute("height",canvasHeight*2),context.scale(2,2)),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}(),ipad?$("#animation_canvas").bind("touchstart",function(a){var b=a.originalEvent.targetTouches[0].pageX-$(this).offset().left,c=a.originalEvent.targetTouches[0].pageY-$(this).offset().top;scene.mouse_down(b,c)}):$("#animation_canvas").mousedown(function(a){var b=a.pageX-$(this).offset().left,c=a.pageY-$(this).offset().top;scene.mouse_down(b,c)}),ipad?$("#animation_canvas").bind("touchmove",function(a){var b=a.originalEvent.targetTouches[0].pageX-$(this).offset().left,c=a.originalEvent.targetTouches[0].pageY-$(this).offset().top;scene.smouse_move(b,c),a.originalEvent.preventDefault()}):$("#animation_canvas").mousemove(function(a){var b=a.pageX-$(this).offset().left,c=a.pageY-$(this).offset().top;scene.mouse_move(b,c)}),ipad?$(document).bind("touchend",function(a){scene.mouse_up()}):$(document).mouseup(function(a){scene.mouse_up()}),animationInit(),mainLoop()}),Object.prototype.create=function(){var a=clone(this);return typeof a.construct=="function"&&a.construct.apply(a,arguments),a},Object.prototype.extend=function(a){var b=clone(this);return forEachIn(a,function(a,c){b[a]=c}),b};var Scene={construct:function(){this.drawables=[]},addDrawable:function(a){this.drawables.push(a)},needsRedraw:!0,redraw:function(){this.needsRedraw=!0},draw:function(){if(this.needsRedraw){context.clearRect(0,0,canvasWidth,canvasHeight);for(var a=0;a<this.drawables.length;a++)this.drawables[a].visible&&(context.save(),this.drawables[a].drawObject(),context.restore());this.needsRedraw=!1}},mouse_down:function(a,b){for(var c=this.drawables.length;c>0;c--)if(this.drawables[c-1].mouse_down(a,b))return!0;return typeof this.onMouseDown=="function"?this.onMouseDown(a,b):!1},mouse_move:function(a,b){for(var c=this.drawables.length;c>0;c--)if(this.drawables[c-1].mouse_move(a,b))return!0;return typeof this.onMouseMove=="function"?this.onMouseMove(a,b):!1},mouse_up:function(){for(var a=this.drawables.length;a>0;a--)if(this.drawables[a-1].mouse_up())return!0;return typeof this.onMouseUp=="function"?this.onMouseUp(x,y):!1},drawLine:function(a,b,c,d){context.beginPath(),context.moveTo(a,b),context.lineTo(c,d),context.stroke()},drawTriangle:function(a,b,c,d,e,f){context.beginPath(),context.moveTo(a,b),context.lineTo(c,d),context.lineTo(e,f),context.closePath(),context.fill(),this.drawLine(a,b,c,d),this.drawLine(c,d,e,f),this.drawLine(e,f,a,b)},drawRectangle:function(a,b,c,d){context.beginPath(),context.moveTo(a,b),context.lineTo(a+c,b),context.lineTo(a+c,b+d),context.lineTo(a,b+d),context.closePath(),context.fill(),context.stroke()},Math:{distance:function(a,b,c,d){return Math.sqrt((a-c)*(a-c)+(b-d)*(b-d))}}},Drawable={construct:function(a,b,c,d){this.setBoundingBox(a,b,c,d),this.setRotation(0),this.children=[]},contains:function(a,b){return a-=this.centerX(),b-=this.centerY(),local_x=a*Math.cos(-this.rotation())+b*Math.sin(-this.rotation()),local_y=b*Math.cos(-this.rotation())-a*Math.sin(-this.rotation()),local_x/=this.scaleX(),local_y/=this.scaleY(),a=local_x+this.centerX(),b=local_y+this.centerY(),a<this.x()+this.width()&&a>this.x()&&b<this.y()+this.height()&&b>this.y()},drawObject:function(){context.strokeStyle=this.strokeStyle,context.fillStyle=this.fillStyle,context.lineWidth=this.lineWidth,context.lineCap=this.lineCap,context.translate(this.centerX(),this.centerY()),context.rotate(-this.rotation()),context.scale(this.scaleX(),this.scaleY()),context.translate(-this.centerX(),-this.centerY()),this.draw(),context.translate(this.x(),this.y());for(index=0;index<this.children.length;index++)this.children[index].drawObject();context.translate(-this.x(),-this.y())},x:function(){return this._x},y:function(){return this._y},width:function(){return this._width},height:function(){return this._height},centerX:function(){return this.x()+this.width()/2},centerY:function(){return this.y()+this.height()/2},rotation:function(){return this._rotation},scaleX:function(){return this._scaleX},scaleY:function(){return this._scaleY},setBoundingBox:function(a,b,c,d){this._x=a,this._y=b,this._width=c,this._height=d,scene.redraw()},setOrigin:function(a,b){this._x=a,this._y=b,scene.redraw()},setX:function(a){this._x=a,scene.redraw()},setY:function(a){this._y=a,scene.redraw()},setCenter:function(a,b){this._x=a-this.width()/2,this._y=b-this.height()/2,scene.redraw()},setRotation:function(a){while(a<0)a+=2*Math.PI;while(a>2*Math.PI)a-=2*Math.PI;this._rotation=a,scene.redraw()},setScale:function(a,b){this._scaleX=a,this._scaleY=b,scene.redraw()},mouse_down:function(a,b){local_x=a-this.centerX(),local_y=b-this.centerY(),child_x=local_x*Math.cos(-this.rotation())+local_y*Math.sin(-this.rotation()),child_y=local_y*Math.cos(-this.rotation())-local_x*Math.sin(-this.rotation()),child_x/=this.scaleX(),child_y/=this.scaleY(),child_x=child_x+this.centerX()-this.x(),child_y=child_y+this.centerY()-this.y();for(index=0;index<this.children.length;index++)if(this.children[index].mouse_down(child_x,child_y))return!0;return typeof this.onMouseDown=="function"?this.onMouseDown(a,b):!1},mouse_move:function(a,b){local_x=a-this.centerX(),local_y=b-this.centerY(),child_x=local_x*Math.cos(-this.rotation())+local_y*Math.sin(-this.rotation()),child_y=local_y*Math.cos(-this.rotation())-local_x*Math.sin(-this.rotation()),child_x/=this.scaleX(),child_y/=this.scaleY(),child_x=child_x+this.centerX()-this.x(),child_y=child_y+this.centerY()-this.y();for(index=0;index<this.children.length;index++)if(this.children[index].mouse_move(child_x,child_y))return!0;return typeof this.onMouseMove=="function"?this.onMouseMove(a,b):!1},mouse_up:function(){for(index=0;index<this.children.length;index++)if(this.children[index].mouse_up())return!0;return typeof this.onMouseUp=="function"?this.onMouseUp():!1},visible:!0,children:null,parent:null,addChild:function(a){this.children.push(a),a.parent=this},strokeStyle:"black",fillStyle:"white",lineWidth:4,lineCap:"round",_rotation:0,_scaleX:1,_scaleY:1},Movable=Drawable.extend({construct:function(a,b,c,d){Drawable.construct.call(this,a,b,c,d)},draw:function(){this.rotatable()&&(size=5,context.fillStyle="red",context.strokeStyle="gray",context.lineWidth=1,Scene.drawLine(this.x(),this.y(),this.x()+this.width(),this.y()),Scene.drawLine(this.x()+this.width(),this.y(),this.x()+this.width(),this.y()+this.height()),Scene.drawLine(this.x()+this.width(),this.y()+this.height(),this.x(),this.y()+this.height()),Scene.drawLine(this.x(),this.y()+this.height(),this.x(),this.y()),context.strokeStyle="black",Scene.drawRectangle(this.x()-size,this.y()-size,2*size,2*size),Scene.drawRectangle(this.x()+this.width()-size,this.y()-size,2*size,2*size),Scene.drawRectangle(this.x()+this.width()-size,this.y()+this.height()-size,2*size,2*size),Scene.drawRectangle(this.x()-size,this.y()+this.height()-size,2*size,2*size))},onMouseDown:function(a,b){return size=5,rotation_x=a-this.centerX(),rotation_y=b-this.centerY(),local_x=rotation_x*Math.cos(-this.rotation())+rotation_y*Math.sin(-this.rotation()),local_y=rotation_y*Math.cos(-this.rotation())-rotation_x*Math.sin(-this.rotation()),rotation_x=local_x+this.centerX(),rotation_y=local_y+this.centerY(),rotation_x>this.x()-size&&rotation_x<this.x()+size&&rotation_y>this.y()-size&&rotation_y<this.y()+size||rotation_x>this.x()+this.width()-size&&rotation_x<this.x()+this.width()+size&&rotation_y>this.y()-size&&rotation_y<this.y()+size||rotation_x>this.x()+this.width()-size&&rotation_x<this.x()+this.width()+size&&rotation_y>this.y()+this.height()-size&&rotation_y<this.y()+this.height()+size||rotation_x>this.x()-size&&rotation_x<this.x()+size&&rotation_y>this.y()+this.height()-size&&rotation_y<this.y()+this.height()+size?(this.rotating=!0,this.rotationAngle=findAngle(this.centerX(),this.centerY(),rotation_x,rotation_y),!0):this.contains(a,b)&&this.movable()?(this.moving=!0,this.offset_x=a-this.x(),this.offset_y=b-this.y(),!0):!1},onMouseMove:function(a,b){return this.rotating?(local_x=a,local_y=b,this.setRotation(findAngle(this.centerX(),this.centerY(),local_x,local_y)-this.rotationAngle),typeof this.onRotate=="function"&&this.onRotate(this.rotation()),scene.redraw(),!0):this.moving?(this.lockMovementX||this.setX(a-this.offset_x),this.lockMovementY||this.setY(b-this.offset_y),typeof this.onMove=="function"&&this.onMove(this.x(),this.y()),scene.redraw(),!0):!1},onMouseUp:function(){return this.rotating?(this.rotating=!1,!0):this.moving?(this.moving=!1,!0):!1},movable:function(){return this._movable},rotatable:function(){return this._rotatable},setMovable:function(a){this._movable=a},setRotatable:function(a){this._rotatable=a},_movable:!1,moving:!1,lockMovementX:!1,lockMovementY:!1,_rotatable:!1,rotating:!1}),Line=Movable.extend({construct:function(a,b,c,d){this.setCorners(a,b,c,d),Movable.construct.call(this,this.x(),this.y(),this.width(),this.height())},draw:function(){Scene.drawLine(this.x1(),this.y1(),this.x2(),this.y2()),Movable.draw.call(this)},x1:function(){return this.x()+this._x1},y1:function(){return this.y()+this._y1},x2:function(){return this.x()+this._x2},y2:function(){return this.y()+this._y2},setCorners:function(a,b,c,d){this._width=Math.max(Math.abs(a-c),20),this._height=Math.max(Math.abs(b-d),20),this.setCenter((a+c)/2,(b+d)/2),this._x1=a-this.x(),this._y1=b-this.y(),this._x2=c-this.x(),this._y2=d-this.y(),scene.redraw()}}),Arc=Movable.extend({construct:function(a,b,c,d,e,f){this.setRadius(c),this.setStartAngle(d),this.setEndAngle(e),this.setCenter(a,b),this.setDirection(f),Movable.construct.call(this,this.x(),this.y(),this.width(),this.height()),this.fillStyle="rgba(0,0,0,0)"},draw:function(){context.beginPath(),context.arc(this.centerX(),this.centerY(),this.radius(),-this.startAngle(),-this.endAngle(),this.direction()),context.fill(),context.stroke(),Movable.draw.call(this)},radius:function(){return this._radius},startAngle:function(){return this._startAngle},endAngle:function(){return this._endAngle},direction:function(){return this._isCounterClockwise},setRadius:function(a){this._radius=a,this._width=2*a,this._height=2*a,scene.redraw()},setStartAngle:function(a){while(a<0)a+=2*Math.PI;while(a>2*Math.PI)a-=2*Math.PI;this._startAngle=a,scene.redraw()},setEndAngle:function(a){while(a<0)a+=2*Math.PI;while(a>2*Math.PI)a-=2*Math.PI;this._endAngle=a,scene.redraw()},setDirection:function(a){this._isCounterClockwise=a,scene.redraw()}}),Circle=Arc.extend({construct:function(a,b,c){Arc.construct.call(this,a,b,c,0,Math.PI*2,!0),this.fillStyle="white"}}),Sector=Arc.extend({construct:function(a,b,c,d,e){Arc.construct.call(this,a,b,c,d,e,!0),this.fillStyle="white"},draw:function(){context.beginPath(),context.moveTo(this.centerX(),this.centerY()),context.arc(this.centerX(),this.centerY(),this.radius(),-this.startAngle(),-this.endAngle(),!0),context.closePath(),context.fill(),context.stroke(),Movable.draw.call(this)},contains:function(a,b){a-=this.centerX(),b-=this.centerY(),local_x=a*Math.cos(-this.rotation())+b*Math.sin(-this.rotation()),local_y=b*Math.cos(-this.rotation())-a*Math.sin(-this.rotation()),a=local_x+this.centerX(),b=local_y+this.centerY();var c=findAngle(this.centerX(),this.centerY(),a,b),d=0;return d=Math.sqrt((a-this.centerX())*(a-this.centerX())+(b-this.centerY())*(b-this.centerY())),c>this.startAngle()&&c<this.endAngle()&&d<=this.radius()}}),Triangle=Movable.extend({construct:function(a,b,c,d,e,f){this.setCorners(a,b,c,d,e,f),Movable.construct.call(this,this.x(),this.y(),this.width(),this.height())},draw:function(){Scene.drawTriangle(this.x1(),this.y1(),this.x2(),this.y2(),this.x3(),this.y3()),Movable.draw.call(this)},x1:function(){return this.x()+this._x1},y1:function(){return this.y()+this._y1},x2:function(){return this.x()+this._x2},y2:function(){return this.y()+this._y2},x3:function(){return this.x()+this._x3},y3:function(){return this.y()+this._y3},setCorners:function(a,b,c,d,e,f){_left=Math.min(a,c,e),_right=Math.max(a,c,e),_top=Math.min(b,d,f),_bottom=Math.max(b,d,f),this._x=_left,this._y=_top,this._width=_right-_left,this._height=_bottom-_top,this._x1=a-this.x(),this._y1=b-this.y(),this._x2=c-this.x(),this._y2=d-this.y(),this._x3=e-this.x(),this._y3=f-this.y(),scene.redraw()}}),Rectangle=Movable.extend({construct:function(a,b,c,d){Movable.construct.call(this,a,b,c,d)},draw:function(){Scene.drawRectangle(this.x(),this.y(),this.width(),this.height()),Movable.draw.call(this)},setCorners:function(a,b,c,d){this._x=a,this._y=b,this._width=Math.abs(a-c),this._height=Math.abs(b-d),scene.redraw()}}),Label=Movable.extend({construct:function(a,b,c){this.fillStyle="black",this.setText(c),Movable.construct.call(this,a,b,this.width(),this.height())},draw:function(){context.font=this._fontSize+"pt "+this._fontFamily,context.textBaseline="top",context.fillText(this.text(),this.x(),this.y()),Movable.draw.call(this)},text:function(){return this._text},fontSize:function(){return this._fontSize},fontFamily:function(){return this._fontFamily},setText:function(a){this._text=a,this.measureSize(),scene.redraw()},setFontSize:function(a){this._fontSize=a,this.measureSize(),scene.redraw()},setFontFamily:function(a){this._fontFamily=a,this.measureSize(),scene.redraw()},measureSize:function(){this._height=this._fontSize*1.5,context.font=this._fontSize+"pt "+this._fontFamily,this._width=context.measureText(this._text).width,scene.redraw()},_fontSize:16,_fontFamily:"Helvetica"});