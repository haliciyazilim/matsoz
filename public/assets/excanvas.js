// Copyright 2006 Google Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
/* -------------------------------------------------------------------- */
function Space(){this.m=this.createMatrixIdentity(),this.mStack=[]}function Point3(a,b,c){this.x=a,this.y=b,this.z=c,this.tx,this.ty,this.tz,this.fx,this.fy}function Shape(){this.points=[],this.polygons=[]}function Polygon(a,b,c,d,e){this.points=a,this.origin=new Point3(0,0,0);for(var f=0;f<this.points.length;f++)this.origin.x+=this.points[f].x,this.origin.y+=this.points[f].y,this.origin.z+=this.points[f].z;this.origin.x/=this.points.length,this.origin.y/=this.points.length,this.origin.z/=this.points.length,b?this.normal=new Point3(this.origin.x+b.x,this.origin.y+b.y,this.origin.z+b.z):this.normal=null,this.backface=c,this.type=d,this.color=e}function Scene(){this.shapes={},this.camera=new Point3(0,0,0),this.cameraTarget=new Point3(0,0,0),this.cameraRotation=0,this.drawlist=[]}var canvas,ctx,canvasWidth,halfCanvasWidth,canvasHeight,halfCanvasHeight,space,scene;Space.prototype.createMatrixIdentity=function(){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},Space.prototype.matrixMultiply=function(a,b){var c=this.createMatrixIdentity(),d=a[0].length,e=a.length;d==b.length;for(var f=0;f<d;f++)for(var g=0;g<e;g++){var h=0;for(var i=0;i<d;i++)h+=a[g][i]*b[i][f];c[g][f]=h}return c},Space.prototype.flatten=function(a){var b=[[a.x,a.y,a.z,1]],c=this.matrixMultiply(b,this.m);a.tx=c[0][0],a.ty=c[0][1],a.tz=c[0][2],a.fx=halfCanvasWidth+canvasWidth*a.tx/a.tz,a.fy=halfCanvasHeight-canvasWidth*a.ty/a.tz},Space.prototype.translate=function(a,b,c){var d=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[a,b,c,1]];this.m=this.matrixMultiply(d,this.m)},Space.prototype.rotate=function(a,b,c){if(b){var d=Math.cos(b),e=Math.sin(b),f=[[d,0,e,0],[0,1,0,0],[-e,0,d,0],[0,0,0,1]];this.m=this.matrixMultiply(this.m,f)}if(a){var g=Math.cos(a),h=Math.sin(a),i=[[1,0,0,0],[0,g,-h,0],[0,h,g,0],[0,0,0,1]];this.m=this.matrixMultiply(this.m,i)}if(c){var j=Math.cos(c),k=Math.sin(c),l=[[j,-k,0,0],[k,j,0,0],[0,0,1,0],[0,0,0,1]];this.m=this.matrixMultiply(this.m,l)}},Space.prototype.push=function(){this.mStack.push(this.m),this.m=[[this.m[0][0],this.m[0][1],this.m[0][2],this.m[0][3]],[this.m[1][0],this.m[1][1],this.m[1][2],this.m[1][3]],[this.m[2][0],this.m[2][1],this.m[2][2],this.m[2][3]],[this.m[3][0],this.m[3][1],this.m[3][2],this.m[3][3]]]},Space.prototype.pop=function(){this.m=this.mStack.pop()},Shape.prototype.draw=function(a){for(var b=0;b<this.points.length;b++)space.flatten(this.points[b]);for(var b=0;b<this.polygons.length;b++){var c=this.polygons[b];space.flatten(c.origin);if(c.normal&&this.backface){space.flatten(c.normal);var d=Math.pow(c.origin.tx,2)+Math.pow(c.origin.ty,2)+Math.pow(c.origin.tz,2),e=Math.pow(c.normal.tx,2)+Math.pow(c.normal.ty,2)+Math.pow(c.normal.tz,2);d>e&&a.push(c)}else a.push(c)}},Polygon.SOLID=0,Polygon.WIRE=1,Polygon.prototype.draw=function(){ctx.beginPath(),ctx.moveTo(this.points[0].fx,this.points[0].fy);for(var a=0;a<this.points.length;a++)ctx.lineTo(this.points[a].fx,this.points[a].fy);ctx.closePath();var b=this.color;if(b.length>3)var c=["rgba(",b[0],",",b[1],",",b[2],",",b[3],")"].join("");else var c=["rgb(",b[0],",",b[1],",",b[2],")"].join("");this.type==Polygon.SOLID?(ctx.fillStyle=c,ctx.fill()):this.type==Polygon.WIRE&&(ctx.strokeStyle=c,ctx.stroke())},Scene.prototype.draw=function(){space.push(),space.translate(-this.camera.x,-this.camera.y,-this.camera.z);var a=this.cameraTarget.x-this.camera.x,b=this.cameraTarget.y-this.camera.y,c=this.cameraTarget.z-this.camera.z,d=Math.sqrt(Math.pow(a,2)+Math.pow(c,2)),e=-Math.atan2(b,d),f=Math.atan2(a,c);space.rotate(e,f,this.cameraRotation),this.drawlist=[];for(var g in this.shapes)this.shapes[g].draw(this.drawlist);this.drawlist.sort(function(a,b){return b.origin.tz-a.origin.tz});for(var g=0;g<this.drawlist.length;g++)this.drawlist[g].draw();space.pop()};